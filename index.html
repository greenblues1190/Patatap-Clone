<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
	<title>Void and Particles</title>
	<script type="text/javascript" src="dist/paper-full.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.0.12/howler.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/paperscript" canvas="myCanvas">
		
		
		var viewCenter = view.center;

		var keyData = {
			a: {
				sound: new Howl({
					src: ['assets/sounds/e4.wav'],
					preload: true
				}),
				color: '#f1c40f'
			},
			s: {
				sound: new Howl({
					src: ['assets/sounds/d4.wav'],
					preload: true
				}),
				color: '#e67e22'
			},
			d: {
				sound: new Howl({
					src: ['assets/sounds/fsharp3.wav'],
					preload: true
				}),
				color: '#e74c3c'
			},
			f: {
				sound: new Howl({
					src: ['assets/sounds/g4.wav'],
					preload: true
				}),
				color: '#95a5a6'
			},
			g: {
				sound: new Howl({
					src: ['assets/sounds/a4.wav'],
					preload: true
				}),
				color: '#f39c12'
			},
			h: {
				sound: new Howl({
					src: ['assets/sounds/csharp3.wav'],
					preload: true
				}),
				color: '#d35400'
			},
			j: {
				sound: new Howl({
					src: ['assets/sounds/fsharp4.wav'],
					preload: true
				}),
				color: '#1abc9c'
			},
			k: {
				sound: new Howl({
					src: ['assets/sounds/a3.wav'],
					preload: true
				}),
				color: '#2ecc71'
			},
			l: {
				sound: new Howl({
					src: ['assets/sounds/b4.wav'],
					preload: true
				}),
				color: '#3498db'
			}
		}

		var atmos1 = new Howl({
			src: ['assets/sounds/atmos1.mp3'],
			loop: true,
			preload: true,
			html5: true,
			volume: 0.7
		});
		var atmos2 = new Howl({
			src: ['assets/sounds/atmos2.wav'],
			loop: true,
			preload: true,
			html5: true,
			volume: 0.9
		});

		// Clear listener after first call.
		atmos1.once('load', function(){
		console.log('atmos1 loaded');
		});
		atmos2.once('load', function(){
			console.log('atmos2 loaded');
		});
		
		
		function circle(circlePath, color) {
			this.circlePath = circlePath;
			this.color = color;
		}
		var circles = [];
		var maxSize = 80;
		var bgmplay = 0;

		var squaresLayer = new Layer();
		
		var blkSquare = new Path.Rectangle({
			position: view.center,
			size: 2000,
			fillColor: 'black'
		});
		var whtSquare = new Path.Rectangle({
			position: view.center,
			size: 2000,
			fillColor: 'white'
		});
		
		
		var currentSquare = whtSquare; 

		var instruction = new PointText({
			position: view.center + [0, 0],
			fillColor: 'black',
			justification: 'center',
			fontSize: 20,
			content: 'Press any Key on keyline [A-L] to Start\nPress spacebar to change mode'
		});

		var circlesLayer = new Layer();

		var firstEvent = 1;
        var gameflag = 0;
        var bwmode = 0;

		function onKeyDown(event) {
			console.log('key code: ' + event.key);
			
			if (keyData[event.key]){
				if (bgmplay == 0) {
					atmos1.play();
					bgmplay = 1;
				}
				var maxPoint = new Point(view.size.width, view.size.height);
				var randomPoint = Point.random();
				var point = maxPoint * randomPoint;
				var newCircle = new circle(
					new Path.Circle(point, maxSize * Math.random() + 10),
					keyData[event.key].color
				);
				if (bwmode == 0) {
					newCircle.circlePath.fillColor = keyData[event.key].color;
				}
				else {
					newCircle.circlePath.fillColor = 'white';
				}
				keyData[event.key].sound.play();
				circles.push(newCircle);

				if (gameflag == 0) {
					gameflag = 1;
				}
			}
			else if (gameflag == 1 && event.key == 'space') {
                if (bwmode == 0) {
                    circlesLayer.blendMode = 'exclusion';
					bwmode = 1;
					circlesLayer.fillColor = 'white';
					atmos1.pause();
					atmos2.play();
                }
                else {
                    bwmode = 0;
					circlesLayer.blendMode = 'normal';
					for (var i = 0; i < circles.length; i++) {
						circles[i].circlePath.fillColor = circles[i].color;
					}
					atmos2.stop();
					atmos1.play();
                }
			}
		}

		function onFrame(event){
			if (gameflag == 1) {
				
				if (instruction && instruction.opacity >= 0.005) {
					instruction.opacity -= 0.005;
				}
				else {
					instruction.remove();
				}
				if (currentSquare.area < 10000000) {
					currentSquare.scale(1.01);
				}
				else {
					if (currentSquare == blkSquare) {
						squaresLayer.insertChild(0, blkSquare);
						whtSquare.scale(0.0005);
						currentSquare = whtSquare;
						console.log("change to white");
					}
					else {
						squaresLayer.insertChild(0, whtSquare);
						blkSquare.scale(0.0005);
						currentSquare = blkSquare;
						console.log("change to black");
						
					}
				
				}
				
				for(var i = 0; i < circles.length; i++){
					circles[i].circlePath.fillColor.brightness -= 0.001;
					circles[i].circlePath.scale(.97, viewCenter);
					
					if (circles[i].circlePath.area < 1){
						circles[i].circlePath.remove();
						circles.splice(i,1);
						i--;
					}	
                }
			}
		}

	</script>
</head>
<body>
	<canvas id="myCanvas" resize></canvas>
</body>
</html>